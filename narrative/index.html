<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">
  <title>UNDP-Narrative</title>
  <!--D3-->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  
  <style>

  </style>

</head>

<body>

  <div id='header'>
    <div id='headerBox'>
    
      <div class="btn" id="expandAll">Expand All</div>
      <div class="btn" id="collapseAll">Collapse All</div>

      <div class="toggle">
        <select id="hider"> <!-- onchange="hider()"-->
          <option selected>All Regions</option>
          <option>Southern</option>
          <option>North</option>
          <option>West</option>
          <option>East</option>
        </select>
      </div>
      
    </div>
  </div>
  
  <div id='intro'>
        
    <h1 id='title'><span id='leadin'>The Impact of </span><br />Violence & Revolution <br />on Inequality in Africa</h1>

    <p id="explainer">
    Africa has been home to over 60 revolution events over the past thirty years. 
    Even with the best of intentions, a coup can have a multitude of results, 
    from a public democracy, to military dictatorship, and everything in between.
    <br /><br />
    
    </p>

    <!--<img id="ptsKey" src="keyNoNum.svg" />-->

  </div>

  <script>
  
    var ptsColors = ['#56c02c', '#fcc30c', '#fd9d24', '#fd6926', '#ff3a22', '#e0240d'];
  
    var margin = {
      top: 0,
      right: 10,
      bottom: 5,
      left: 5
    };

    var width = 650 - margin.left - margin.right,
      height = 20 - margin.top - margin.bottom;

    var xScale = d3.scaleLinear()
      .range([0, width])
      .domain([1976, 2016]);
      
    var yScaleGini = d3.scaleLinear()
      .range([height, 0])
      .domain([0, 100]);

    var yScale = d3.scaleLinear()
      .range([height, 0])
      .domain([0, 5]);

    var xAxis = d3.axisTop()
      .tickFormat(d3.format("d"))
      .tickValues([1980, 1984, 1988, 1992, 1996, 2000, 2004, 2008, 2012])
      .scale(xScale);

    var yAxis = d3.axisRight()
      .ticks(4)
      .scale(yScale);
      
    var yAxisGini = d3.axisRight()
      .ticks(4)
      .scale(yScaleGini);

    var barWidth = width / (2016 - 1976);


    d3.json('data/v2-consolidated.json', drawCharts);
    
    //hider isolates regions
    function hider(selected) {
      return function(d) {
          
          var index = d3.event.target.selectedIndex;
        
          var regions = ['All', 'Southern', 'North', 'West', 'East', 'Central'];
          
          if (regions[index] == 'All') {
            d3.selectAll('div.chart').classed('hidden', false);
          } else { // region selected
            for (var i in regions) {
            	if (regions[i] !=  regions[index]) {
            	  d3.selectAll('div.'+regions[i]).classed('hidden', true);
              } else {   
                d3.selectAll('div.'+regions[i]).classed('hidden', false);
              }
            } // end loop
          } // end region selected
      
      }
    }


    //close all charts
    function collapseAll() {
      return function(d) {
        var allCharts = d3.selectAll('div.chart');
        collapseChart(d, allCharts);
        closed(allCharts);
      }
    }

    //close full detail view 
    function closeChart() {
      return function(d) {
        var thisDiv = d3.select(this.parentNode);
        collapseChart(d, thisDiv, function() {
          closed(thisDiv);
        });
      }
    }

    //remove class 'open'
    function closed(thisDiv) {
      thisDiv.classed('open', false);
    }

    function collapseChart(d, thisDiv) {

      var newHeight = 20 - margin.top - margin.bottom;
      yScale.range([newHeight, 0])
      yScaleGini.range([0, newHeight]);

      //select the chart
      var chart = thisDiv.select('svg')
        .transition()
        .duration(500);

      //update pts bars  
      chart.selectAll('rect.ptsAvg')
        .attr('y', function(d) {  return yScale(d.value.ptsAvg);  })
        .attr('height', function(d) {  return newHeight - yScale(d.value.ptsAvg);  });
      
      //update gini bars
      chart.selectAll('rect.giniAvg')
        .attr('y', newHeight)
        .attr('height', function(d) {  return yScaleGini(d.value.giniAvg);  });

      //update pitf bar
      chart.selectAll('rect.pitf')
        .attr('y', newHeight);

      //hide pitf data
      chart.selectAll('text.pitf.brief')
        .attr('y', 0)
        .style('opacity', 0);

      chart.selectAll('text.pitf.date')
        .attr('y', 0)
        .style('opacity', 0);

      chart.selectAll('text.pitf.read')
        .attr('y', 0)
        .style('opacity', 0);

      //hide axes
      chart.selectAll('.axis').style('opacity', 0);

      chart.select('.y').call(yAxis);
        
      chart.select('.yGini').call(yAxisGini);

      chart.selectAll('.x.axis')
        .attr('transform', 'translate(0, ' + newHeight + ')');

      thisDiv.select('svg').attr('overflow', 'hidden');

      chart.attr('height', newHeight);

      //close div
      thisDiv.transition()
        .duration(500)
        .style('height', '30px'); // HEIGHT CLOSED

    }

    function expandAll() {
      return function(d) {
        var allCharts = d3.selectAll('div.chart');
        expandChart(allCharts, d)
      }
    }

    //show full detail view of country on click
    function chartClick() {
      return function(d) {
        var thisDiv = d3.select(this);
        expandChart(thisDiv, d);
        
      }
    }

    function expandChart(thisDiv, d) {
      //make sure chart is not already open
      if (!thisDiv.classed('open')) {

        thisDiv.classed('open', true);
        
        //make chart taller
        var divHeight = 160;
        
        thisDiv.transition()
          .duration(500)
          .style('height', divHeight+'px');
          // .select('h1.chart')
          // .style('top', (divHeight/2)+'px');
        
        //declare var for use in svg, adjust yScale
        var newHeight = 70;
        yScale.range([newHeight, 0]);
        yScaleGini.range([0, newHeight]);

        //access data
        var years = d3.entries(d.value.years);

        //update height of container
        var chart = thisDiv.select('svg')
          .transition()
          .duration(500)
          .attr('height', newHeight);

        //update pts bars
        chart.selectAll('rect.ptsAvg')
          .attr('y', function(d) {
            return yScale(d.value.ptsAvg);
          })
          .attr('height', function(d) {
            return newHeight - yScale(d.value.ptsAvg);
          });
          
        //update gini bars
        chart.selectAll('rect.giniAvg')
          .attr('y', newHeight)
          .attr('height', function(d) {  return yScaleGini(d.value.giniAvg);  });

        //show pitf data
        chart.selectAll('text.pitf.brief').attr('y', newHeight + 24).style('opacity', 1);

        chart.selectAll('text.pitf.date').attr('y', newHeight + 12).style('opacity', 1);

        chart.selectAll('text.pitf.read').attr('y', newHeight + 36).style('opacity', 1);
          
        chart.selectAll('rect.giniAvg').attr('y', newHeight);
          
        chart.selectAll('rect.pitf').attr('y', newHeight);

        //show axes
        chart.selectAll('.axis').style('opacity', 1);

        chart.select('.y').call(yAxis);
          
        chart.select('.yGini')
          .call(yAxisGini)
          .attr('transform', 'translate(0, ' + newHeight + ')');

        chart.selectAll('.x.axis')
          .attr('transform', 'translate(0, ' + newHeight + ')');
        
      } // end if
    } // end function expand chart   

    function openModal(id) {
      d3.selectAll(id).style('display', 'visible');
    }

    function closeModal(id) {
      d3.selectAll(id).style('display', 'hidden');
    }
    
    function reg(fullRegion) {
      var firstWord = fullRegion.split(" ")[0].toLowerCase();
      return firstWord;
    }

    function drawCharts(data) {
      var body = d3.select('body');
      
      data = d3.entries(data);
      
      data.sort(function(a,b) {
        return b.value.overallPTS-a.value.overallPTS;
      })
      
      // buttons to expand / collapse all
      body.select('#collapseAll')
        .on('mouseup', collapseAll());
        
      body.select('#expandAll')
        .data(data)  // data has to be re-bound, unsure as to why
        .on('mouseup', expandAll());
      
      body.select('#hider')
        .on('change', hider());
      
      console.log(data);
      
      //draw chart
      var svg = body.selectAll('div.chart')
        .data(data)
        .enter()
        .append('div')
        .attr('class', function(d) {
          return d.value.region + ' chart';
        })
        .each(function(d) {
          var block = d3.select(this);
          block.on('mouseup', chartClick());
          drawChart(block, d);

        }); //end each
        
    }

    function drawChart(elem, d) {

      var country = d.value.name;
      
      // elem.append('h5').attr('class', 'chart').text(d.value.region+' Africa');
      elem.append('h1').attr('class', 'chart').text(country);
      
      var chart = elem.append('svg')
        .attr('width', width + margin.right + margin.left)
        .attr('height', height + margin.top + margin.bottom);

      var years = d3.entries(d.value.years);

      //append bars
      chart.selectAll('rect.ptsAvg')
        .data(years)
        .enter()
        .append('rect')
        .attr('class', 'ptsAvg')
        .attr('x', function(d) {
          return xScale(parseFloat(d.key));
        })
        .attr('y', function(d) {
          return yScale(d.value.ptsAvg);
        })
        .attr('width', barWidth)
        .attr('height', function(d) {
          return height - yScale(d.value.ptsAvg);
        })
        .attr('fill', function(d) {
          var i = Math.ceil(d.value.ptsAvg)-1;
          return ptsColors[i];
        });
        // .style('opacity', function(d) {
        //   if (d.value.ptsEst) {
        //     return 0.8;
        //   } else {
        //     return 1;
        //   }
        // });

      chart.selectAll('rect.giniAvg')
        .data(years)
        .enter()
        .append('rect')
        .attr('class', function(d){
          return d.value.giniEst+' giniAvg';
        })  //'giniAvg'
        .attr('x', function(d) {
          return xScale(parseFloat(d.key));
        })
        .attr('y', function(d) {
          return height;
        })
        .attr('width', barWidth)
        .attr('height', function(d) {
          return height - yScaleGini(d.value.giniAvg)
        });

      var pitf = d.value.pitf;

      // append pitf
      chart.selectAll('rect.pitf')
        .data(pitf)
        .enter()
        .append('rect')
        .attr('class', 'pitf')
        .attr('x', function(d) {
          return xScale(began(d.began));
        })
        .attr('y', height - 2)
        .attr('height', 2)
        .attr('width', function(d) {
          var length = xScale(endedNum(d.ended)) - xScale(began(d.began));

          if (length > 0) {
            return length;
          }
          else {
            return barWidth;
          }
        });

      //descriptions of events

      chart.selectAll('text.pitf.brief')
        .data(pitf)
        .enter()
        .append('text')
        .attr('class', 'pitf brief')
        .text(function(d) {
          var findSpace = d.eventDescription.slice(20, 40).indexOf(' ');
          return d.eventDescription.slice(0, 20 + findSpace) + '...';
        });

      chart.selectAll('text.pitf.date')
        .data(pitf)
        .enter()
        .append('text')
        .attr('class', 'pitf date')
        .text(function(d) {
          var dates = Math.floor(parseFloat(d.began)) + '-' + endedString(d.ended);
          return dates;
        });

      chart.selectAll('text.pitf.read')
        .data(pitf)
        .enter()
        .append('text')
        .attr('class', 'pitf read')
        .text('Read More')
        .on('mouseup', showFullText(d, country));

      chart.selectAll('text.pitf')
        .attr('text-anchor', function(d) {
          if (parseFloat(d.began) > 2007) {
            return 'end';
          }
          else {
            return 'start';
          }
        })
        .attr('x', function(d) {
          if (parseFloat(d.began) > 2007) {
            return xScale((endedNum(d.ended)));
          } else {
            return xScale(parseFloat(beganText(d.began)));
          }
        })

      // create axes
      chart.append('g')
        .call(xAxis)
        .attr('class', 'x axis')
        .attr('transform', 'translate(0, ' + height + ')');

      chart.append('g')
        .call(yAxis)
        .attr('class', 'y axis');
        
      chart.append('g')
        .call(yAxisGini)
        .attr('class', 'yGini axis')
        .attr('transform', 'translate(0, ' + height + ')');
        
    } // end draw charts

    function showFullText(d, country) {
      return function(d) {

        // console.log(d.began);
        var dates = d.began + ' - ' + endedString(d.ended);

        d3.select('body')
          .append('div')
          .attr('class', 'modal back')
          .on('mouseup', removeModal());

        textBox = d3.select('body')
          .append('div')
          .attr('class', 'modal front');

        textBox.append('span')
          .text(dates);

        textBox.append('h1')
          .text(country)

        textBox.append('p')
          .text(d.eventDescription);

        textBox.append('p')
          .attr('class', 'sources')
          .html('Description quoted verbatim from <a href="http://www.systemicpeace.org/inscr/PITF%20Consolidated%20Case%20List%202015.pdf">Center for Systemic Peace INSCR Consolidated Case List</a> (Accessed Oct. 2017)');

      }
    }

    function removeModal() {
      return function() {

        d3.selectAll('div.modal')
          .remove();

      }
    }

    function endedString(d) {
      var numDate = Math.floor(parseFloat(d)); //.ended

      if (isNaN(numDate)) {
        return 'ONGOING';
      }
      else {
        return numDate;
      }

    }
    
    //date parsers for pitf data
    function began(d) {
        if (parseFloat(d) > 1976) {
          return parseFloat(d);
        }
        else {
          return 1976;
        }
    }

    function beganText(d) {
        if (parseFloat(d) > 1976) {
          return parseFloat(d);
        }
        else {
          return 1977.5;
        }
    }

    function endedNum(d) {
        var numDate = Math.floor(parseFloat(d)); //.ended
        if (isNaN(numDate)) {
          return 2016;
        }
        else {
          return numDate+1;
        }
    }
    
    
  </script>

</body>


</html>
