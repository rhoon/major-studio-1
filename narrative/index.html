<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="UTF-8">
    <title>UNDP-Narrative</title>
    <!--D3-->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet">

    <style> 
    body {
      font-family: 'Open Sans', sans-serif;
      font-weight: 400;
      text-align: left;
    }
    
    h1 {
      text-align: left;
      font-size: 15px;
      font-weight: 300;
      display: none;
    }
    
    div {
      padding: 0;
      margin: 0;
      height: 20px;
      /*border: 1px solid grey;*/
      overflow: hidden;
      width: 1000px;
      margin: auto 50%;
    }
    
    svg {
      padding: 0;
      margin: 0;
      position: relative;
      top: 0px;
    }
    
    rect.ptsAvg {
      fill: #ffe41f;
      opacity: 1;
    }
    
    p.country {
      position: relative;
      top: -20px;
      text-align: left;
    }
    
    </style>
    
  </head>

  <body>
    
    <script>
    
    var margin = {top: 0, right: 10, bottom: 5, left: 5};

    var width = 800 - margin.left - margin.right,
        height = 15 - margin.top - margin.bottom;
        
    var xScale = d3.scaleLinear()
        .range([0, width])
        .domain([1976, 2016]);

    var yScale = d3.scaleLinear()
        .range([height, 0])
        .domain([0, 100]);
        
    var xAxis = d3.axisTop()
        .tickFormat(d3.format("d"))
        .scale(xScale);
    
    var yAxis = d3.axisLeft()
        .scale(yScale);
        
    var barWidth = width/(2016-1976);
    console.log('barWidth: '+barWidth);
    
    d3.json('data/pts+pitf.json', drawCharts);
    
    //show full detail view of country
    function chartClick() {
      return function(d) {
        
        var thisDiv = d3.select(this);
        
        thisDiv.transition()
          .duration(500)
          .style('height', '300px');
        
      }
    }
    
    
    //show a light detail view of a country
    function chartOn(name, dy) {
      return function() {
        
      d3.select(this)
        .transition()
        .duration(500)
        .style('height', '80px')
      .select('svg')
        .style('top', '50px');
        
      //appending element transitions? (eg having text fade in)
        
      d3.select(this)
      .append('p')
        .attr('class', 'country')
        .attr('x', 0)
        .attr('y', height)
        .text(name);
      
      };
    }
    
    //move things back
    function chartOff() {
      return function() {
        
      var thisBlock = d3.select(this);
        thisBlock.transition()
          .duration(500)
          .style('height', '20px')
        .select('svg')
          .style('top', '0px');
          
        thisBlock.select('p.country')
          .transition()
          .duration(500)
          .remove();

        console.log('mouseOFF');
      }
    }
    
    
    function drawCharts(data) {
      console.log('entries');
      console.log(d3.entries(data));
      
      data = d3.entries(data);
      
      body = d3.select('body');
    
      var svg = body.selectAll('div')
          .data(data)
          .enter()
          .append('div')
            .each(function(d) {
              // console.log(d);
              
              //   var firstLetter = d['Country Name'].toUpperCase().charAt(0);
              var block = d3.select(this);
              
              block.on('mouseenter', chartOn(d.value.name, "-1em"))
                .on('mouseleave', chartOff())
                .on('click', chartClick());
              
              drawChart(block, d);
                  
              }); //end each
        
      }
        
function drawChart(elem, d) {
  var chart = elem.append('svg')
    .attr('width', width+margin.right+margin.left)
    .attr('height', height+margin.top+margin.bottom)
  
  var years = d3.entries(d.value.years);
  
  //append bars
  chart.selectAll('rect.ptsAvg')
      .data(years)
      .enter()
      .append('rect')
      .attr('class', 'ptsAvg')
      .attr('x', (d) => { 
          return xScale(parseFloat(d.key));
      })
      .attr('y', (d) => { 
          return yScale(20*d.value.ptsAvg);
      })
      .attr('width', barWidth)
      .attr('height', (d) => { 
          return height-yScale(20*d.value.ptsAvg);
      });

  var pitf = d.value.pitf;
  
  // append pitf
  chart.selectAll('rect.pitf')
      .data(pitf)
      .enter()
      .append('rect')
      .attr('class', 'pitf')
      .attr('x', (d) => {
        return xScale(parseFloat(d.began));
      })
      .attr('y', height-1)
      .attr('height', 1)
      .attr('width', (d) => {
        var length = xScale(parseFloat(d.ended))-xScale(parseFloat(d.began));
        console.log('duration');
        console.log(parseFloat(d.duration));
        if (length > 0) {
          return length;
        } else {
          return barWidth;
        }
      }); 
}



    
    </script>
  </body>
